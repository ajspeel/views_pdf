<?php

/**
 * @file
 * Contains \Drupal\views_pdf\Tests\Display\ViewsPdfDisplayTests.
 */

class ViewsPdfPageDisplayTest extends DrupalWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name'        => 'Views PDF Page',
      'description' => 'Test creating basic views PDF page.',
      'group'       => 'Views PDF',
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {

    if (module_exists('simpletest_turbo')) {

      $id = simpletest_turbo_id('views_pdf_page_display');

      if (db_table_exists('fasttest' . $id . 'node')) {
        $this->prepareDatabasePrefix();
        $this->prepareEnvironment();
        $this->changeDatabasePrefix();
        simpletest_turbo_copy_tables('fasttest' . $id, $this->databasePrefix);
        variable_set('file_public_path', $this->public_files_directory);
        variable_set('file_private_path', $this->private_files_directory);
        variable_set('file_temporary_path', $this->temp_files_directory);
        $this->setup = TRUE;
      }
      else {

        // Enable views_ui, views_pdf.
        parent::setUp(array('views_ui', 'views_pdf'));


        // Create and log in a user with administer views permission.
        $views_admin = $this->drupalCreateUser(array(
          'administer views',
          'administer blocks',
          'bypass node access',
          'access user profiles',
          'view revisions',
        ));

        // Remember all tables.
        $this->drupalLogin($views_admin);
        simpletest_turbo_copy_tables($this->databasePrefix, 'fasttest' . $id);
      }
    }
    else {

      // Enable views_ui, views_pdf.
      parent::setUp(array('views_ui', 'views_pdf'));

      // Create and log in a user with administer views permission.
      $views_admin = $this->drupalCreateUser(array(
        'administer views',
        'administer blocks',
        'bypass node access',
        'access user profiles',
        'view revisions',
      ));

      $this->drupalLogin($views_admin);
    }

  }

  /**
   * Pagers was sometimes not stored.
   *
   * @see http://drupal.org/node/652712
   */
  public function testCreatePagePdf() {

    // Create nodes.
    for ($i = 0; $i < 11; $i++) {
      $this->drupalCreateNode();
    }

    $admin_user = $this->drupalCreateUser(array(
      'administer views',
      'administer site configuration',
    ));

    $this->drupalLogin($admin_user);

    $this->drupalGet('admin/structure/views/add');

    $edit = array(
      'page[create]' => 0,
    );
    $this->drupalPost('admin/structure/views/nojs/display/frontpage/default/pager_options', $edit, t('Apply'));
    $this->assertText('5 items');

  }

}
