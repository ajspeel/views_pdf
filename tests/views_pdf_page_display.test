<?php

/**
 * @file
 * Contains \Drupal\views_pdf\Tests\Display\ViewsPdfDisplayTests.
 */

class ViewsPdfPageDisplayTests extends DrupalWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name'        => 'Views PDF Page',
      'description' => 'Test creating basic views PDF page.',
      'group'       => 'Views PDF',
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {

    // Support for Simpletest Turbo module.
    if (module_exists('simpletest_turbo')) {

      $id = simpletest_turbo_id('views_pdf_turbo_page');

      if (db_table_exists('fasttest' . $id . 'node')) {
        $this->prepareDatabasePrefix();
        $this->prepareEnvironment();
        $this->changeDatabasePrefix();
        simpletest_turbo_copy_tables('fasttest' . $id, $this->databasePrefix);
        variable_set('file_public_path', $this->public_files_directory);
        variable_set('file_private_path', $this->private_files_directory);
        variable_set('file_temporary_path', $this->temp_files_directory);
        $this->setup = TRUE;
      }
      else {
        parent::setUp();
        // Remember all tables.
        simpletest_turbo_copy_tables($this->databasePrefix, 'fasttest' . $id);
      }
    }
    else {
      // Enable views_ui.
      parent::setUp('views_ui');

      parent::setUp('views_pdf');

      // Create and log in a user with administer views permission.
      $views_admin = $this->drupalCreateUser(array('administer views', 'administer blocks', 'bypass node access', 'access user profiles', 'view revisions'));
      $this->drupalLogin($views_admin);
    }
  }

  /**
   * Pagers was sometimes not stored.
   *
   * @see http://drupal.org/node/652712
   */
  public function testStorePagerSettings() {
    $admin_user = $this->drupalCreateUser(array(
      'administer views',
      'administer site configuration'
    ));
    $this->drupalLogin($admin_user);

    $this->drupalGet('admin/structure/views/view/frontpage/edit');

    $edit = array(
      'pager_options[items_per_page]' => 5,
    );
    $this->drupalPost('admin/structure/views/nojs/display/frontpage/default/pager_options', $edit, t('Apply'));
    $this->assertText('5 items');

  }

}
